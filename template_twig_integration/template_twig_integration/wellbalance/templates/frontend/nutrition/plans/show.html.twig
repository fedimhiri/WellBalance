{% extends 'frontend/base_frontend.html.twig' %}

{% block title %}Détails plan{% endblock %}

{% block body %}
{% set totalCalories = 0 %}
{% for r in plan.repas %}
  {% set totalCalories = totalCalories + (r.calories ?? 0) %}
{% endfor %}

{% set nbRepas = plan.repas|length %}
{% set avgCalories = nbRepas > 0 ? (totalCalories / nbRepas) : 0 %}
{% set actif = plan.dateFin > date() %}

<div class="container py-4">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-1">{{ plan.objectif }}</h2>
      <div class="text-muted">
        {{ plan.dateDebut|date('d/m/Y') }} → {{ plan.dateFin|date('d/m/Y') }}
        • <strong>{{ actif ? 'Actif' : 'Terminé' }}</strong>
      </div>
    </div>

    <!-- ✅ BOUTONS PDF + RETOUR -->
    <div class="d-flex gap-2">
      <a class="btn btn-outline-danger"
         href="{{ path('front_plan_nutrition_pdf', {id: plan.id}) }}">
        <i class="bx bxs-file-pdf me-2"></i>PDF
      </a>

      <a class="btn btn-outline-secondary"
         href="{{ path('front_plan_nutrition_index') }}">
        Retour
      </a>
    </div>
  </div>

  <!-- STATS -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card"><div class="card-body">
        <div class="text-muted small">Nombre de repas</div>
        <div class="fs-4 fw-bold">{{ nbRepas }}</div>
      </div></div>
    </div>
    <div class="col-md-3">
      <div class="card"><div class="card-body">
        <div class="text-muted small">Total calories</div>
        <div class="fs-4 fw-bold">{{ totalCalories }}</div>
      </div></div>
    </div>
    <div class="col-md-3">
      <div class="card"><div class="card-body">
        <div class="text-muted small">Moyenne / repas</div>
        <div class="fs-4 fw-bold">{{ avgCalories|number_format(0) }}</div>
      </div></div>
    </div>
    <div class="col-md-3">
      <div class="card"><div class="card-body">
        <div class="text-muted small">Jours restants</div>
        <div class="fs-4 fw-bold">{{ actif ? plan.dateFin.diff(date()).days : 0 }}</div>
      </div></div>
    </div>
  </div>

  <!-- REPAS -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h4 class="mb-0">Mes repas</h4>
    <a class="btn btn-success btn-sm"
       href="{{ path('front_repas_new', {id: plan.id}) }}">+ Ajouter repas</a>
  </div>

  {% if plan.repas|length == 0 %}
    <div class="alert alert-info">Aucun repas ajouté.</div>
  {% else %}
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Calories</th>
          <th>Description</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in plan.repas %}
          <tr>
            <td>{{ r.dateRepas|date('d/m/Y H:i') }}</td>
            <td>{{ r.typeRepas }}</td>
            <td>{{ r.calories }}</td>
            <td>{{ r.description }}</td>
            <td>
              <a class="btn btn-sm btn-primary"
                 href="{{ path('front_repas_edit', {id: r.id}) }}">Modifier</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
</div>
{% endblock %}
